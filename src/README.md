The Problem could be solved much easier using Pivot tables and advanced aggregations, however I am not very familiar with Pivot tables and I am limited by time. 
